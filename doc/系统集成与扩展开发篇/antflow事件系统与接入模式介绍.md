
AntFlow事件系统是一个基于Activiti工作流引擎的事件驱动架构，主要包含三个层次的事件处理机制：Activiti原生事件系统、AntFlow业务操作监听器和消息通知系统。
AntFlow的事件系统是基于Activiti工作流引擎构建的，提供了完整的事件监听、分发和处理机制。除了可以使用activiti自身的事件监听机制,还可以使用antflow自定义的很多事件监听机制来实现业务。

> 如非特殊需求，建议使用antflow自身的事件机制来处理逻辑，antflow自身的事件机制包含了更多业务相关的数据。

## 1. AntFlow DIY流程事件钩子

antflow自定义（DIY）流程需要实现FormOperationAdaptor，这是一个泛型接口，泛型参数为提交表单的内容的实体（不必须是表单里的业务数据，也可以包含其它任意内容，由业务决定），此接口定义了很多流程流转钩子，用户只需要在指定的钩子函数里填充代码即可完成流程后端业务编排。

### 1.1 DIY流程钩子函数结合三方账号申请demo流程说明

| 方法名                    | 功能描述                                   | 第三方账号申请demo中的实现                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | 是否必需 |
| ------------------------- | ------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------- |
| `previewSetCondition()` | 设置流程预览条件，用于预览流程路由         | 流程预览条件，此方法用于流程发起时点击流程预览tab或者流程审批过程中点击预览tab时<br />为预览提供条件分支决策用的条件参数，表单中有很多参数，但是往往只有一两个是条件字段<br />这时候需要用户将条件字段赋值到BpmnStartConditionsVo对象里面返回。还有一些条件可能不是<br />表单中的，比如发起人所在部门不同流程分支也不一样，这时候就可能需要查库，这时候可以拿到发起人id（三方账号申请<br />demo流程中有案例），从库中查出发起人所在部门的id，然后赋值。总之，表单中有的直接从表单取，没有的则通过其它办法取。<br />需要说明的是如果一个流程没有条件分支，则不需要处理逻辑，但是需要返回一个空对象！不然会报错。                                                                                                                                        | 非必需   |
| `initData()`            | 初始化流程数据，大多数情况下不是必需方法   | 返回null，未实现特殊初始化逻辑，暂未实现，为后面流程草稿箱功能预留的                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 非必需   |
| `launchParameters()`    | 设置流程启动参数，即使没有启动条件也应定义 | 此方法和 `previewSetCondition`功能类似，但是前者用于流程预览时决策流程分支，后者用于流程发起时决策流程分支                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | 非必需   |
| `queryData()`           | 查询业务数据，供审批人员参考               | 此方法用于渲染流程审批时的表单，供审批人查看。此方法会携带businessId字段，即为业务数据的主键。不少用户有疑问只有一个Id，<br />我如何知道去查哪个表，其实写一个流程跑一下就知道了。实现FormOperationAdaptor的子类都是一个特定的流程，用户自己设计的，当然知道自己的<br />业务数据存在哪里了。另一个常见问题是假如有一个很复杂的流程，用到了很多表，如何根据businessId去查表呢。这时候就需要一点设计构造了。这些表<br />之间不是完全孤立的。一个流程相关的表肯定有内在的业务关联。businessId可以存主表的Id，需要关联数据时根据他们和主表的关联关系拿到。<br />有些用户可能会说我这些表之间就是没有关系，并且是线上已经有的表，不方便改，该怎么办？这时候可以新建一个表，存和这个流程相关的表的记录id（或者其它<br />字段），使用这个表来带出其它表信息。 | 非必需   |
| `submitData()`          | 提交流程数据，处理业务数据提交             | 将申请数据插入数据库，设置流程标题和摘要。需要说明的是，这个表格里的方法并没有先后顺序。上面 `queryData`里介绍了很多东西，可能用户对businessId一头雾水，它是哪里来的，实际上它是流程提交时写入库里的，写入库之后再将数据记录的id返回出来，赋值给实体对象的businessId字段<br />antflow就会将此字段存在bpm_business_process表里面，此表是antflow流程和业务关联的核心表！！！后面流程审批需要表单数据，引擎就会调用 `queryData`方法，将业务id携带给用户，用户拿着他去查询表单数据然后返回                                                                                                                                                                                                                                                             | 非必需   |
| `consentData()`         | 审批人提交审批时的业务逻辑处理             | 处理重新提交操作，更新申请数据和流程同意时更新数据。如何知道是是同意还是重新提交操作呢？根据operationType来判断，参考三方账号申请。<br />需要说明的是，很多流程流转过程中是不会更新表单的，那么此回调就不用处理。但是重新提交往往涉及表单更新操作，需要处理                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 非必需   |
| `backToModifyData()`    | 流程退回修改时的处理逻辑                   | 未实现具体逻辑                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | 非必需   |
| `cancellationData()`    | 流程取消时的业务逻辑处理                   | 未实现具体逻辑                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | 非必需   |
| `finishData()`          | 流程完成时的业务逻辑处理                   | 用户可以在此钩子里面做各种流程完成事后的操作。比如给用户发短信等。当然如果是发短信建议使用事件通知机制，不要在这里写方法                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | 非必需   |

> `FormOperationAdaptor`通过 `@ActivitiServiceAnno`注解进行服务注册,不能使用spring里的普通service

### 1.2 低代码流程（LF）钩子函数说明

低代码实现原理是将低代码本身做为一个DIY流程，实现类是LowFlowApprovalService，由于它是一个通用的处理所有低代码流程的一个服务，但是有些低代码流程又需要处理一定的业务逻辑，因此设计了LFFormOperationAdaptor

需要注意的是实现此类的服务不能再加 `@ActivitiServiceAnno`注解了，而是使用spring 普通的service注解，和FormOperationAdaptor api都相同，差异在于实现了LFFormOperationAdaptor的服务并不能自动确定是哪个低代码流程，因此
需要从BusinessDataVo中取出formcode判断和当前要处理业务的formCode是否相同，只有相同才处理业务！

### 1.3全局钩子函数

以上1.1和1.2介绍的都是和流转业务密切相关的一些钩子函数。但是有些事件和流转流转本身关系不大，比如管理员变更当前节点处理人、流程被加批、减批等动作。用户相对这些事件也进行精细控制，此时可以在AntFlowOperationListener里相应的
事件方法里编写逻辑。需要说明的是这里的事件都是全局的，如果是对特定流程事件进行处理，如果是DIY流程强烈建议在FormOperationAdaptor的实现类里处理。低代码的如果需要特殊处理的不多，可以在这个全局监听器里处理，如果非常多流程都需要特殊处理，建议需要特殊处理的流程实现LFFormOperationAdaptor处理特殊逻辑。

此全局事件处理器涵盖了流转流程的所有操作。不少事件消息就是通过这里实现的.

### 1.4流程给下一节点审批人分配任务和完成事件。

#### 1.4.1 BpmnTaskListener

前面讲到antflow定义了丰富的事件。这些事件往往都是基于操作动作的。如果用户想实现如果流程流转到某个审批人那里，给他发一条消息，则以上事件就不管用了（用户点击审批的时候任务已经分配给他了，这个分配是在上一节点完成时自动触发的，它是activiti的一个内部事件），这时候就需要BpmnTaskListener，它是流程给节点审批人分配任务的事件。

> 如果用户想要实现给审批人发消息，在通知系统里里配置就行了，强烈建议不要在这是写业务代码

### 1.5流程完成事件BpmnExecutionListener

其实上面讲到的不管是FormOperationAdaptor和LFFormOperationAdaptor里面的finishData都是通过此activiti流程完成事件触发的。同样不建议在这里实现业务逻辑

### 1.6 activiti所有事件BpmnGlobalEventListener，如果以上还不够，此类几乎覆盖了activiti的所属事件

> 同样，强烈建议勿要滥用此类，尽量antflow提供的事件钩子里完成业务
